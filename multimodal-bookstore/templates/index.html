<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bookstore AI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <nav class="nav-icons top">
        <button><i class="fa-solid fa-book"></i></button>
        <button><i class="fa-solid fa-heart"></i></button>
        <button><i class="fa-solid fa-play"></i></button>
        <button id="add-book-btn"><i class="fa-solid fa-plus"></i></button>
      </nav>
      <nav class="nav-icons bottom">
        <button><i class="fa-solid fa-gear"></i></button>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main">
      <div class="search-bar">
        <input type="text" placeholder="Search for books">
        <button class="search-btn">Search</button>
      </div>

      <div class="categories">
        <button class="active">Popular</button>
        <button>All</button>
        <button>eBooks</button>
        <button>Bestsellers</button>
        <button>Audiobooks</button>
        <button>Romance</button>
        <button>Fantasy</button>
        <button>Manga</button>
      </div>

      <!-- Popular -->
      <section class="popular">
        <h2>Popular</h2>
        <div class="book-list" id="book-list">
        </div>
      </section>

      <!-- Recommended -->
      <section class="recommended">
        <h2>Recommended for you</h2>
        <div class="scroll-row" id="recommended-list"></div>
      </section>
    </main>

    <!-- Chatbox -->
    <aside class="chatbox">
      <h2>Chat</h2>
      <div id="chat-messages"></div>
      <div id="input-attachments" style="display:flex; gap:10px; margin-top:5px;"></div>

      <!-- Chat input -->
      <div class="chat-input">
        <input type="text" id="user-input" placeholder="Write a message...">
        <!-- Upload file -->
        <label for="file-upload" class="upload-btn"><i class="fa-solid fa-image"></i></label>
        <input id="file-upload" type="file" accept="image/*" hidden>
        <!-- Crop screen -->
        <button id="crop-btn" type="button"><i class="fa-solid fa-crop"></i></button>
        <button id="send-btn" type="button"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </aside>
  </div>

  <!-- Book Detail Modal -->
  <div id="book-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBookModal()">&times;</span>
      <img id="modal-cover" src="" alt="Book cover" style="max-width:200px;">
      <h3 id="modal-title"></h3>
      <p id="modal-author"></p>
      <span id="modal-price"></span>
    </div>
  </div>

  <!-- Add Book Modal -->
<div id="add-book-modal" class="modal">
  <div class="modal-content add-book-form">
    <span class="close" onclick="closeAddBookModal()">&times;</span>
    <h2>‚ûï Add New Book</h2>
    <form id="add-book-form" enctype="multipart/form-data">
      <div class="form-group">
        <label for="new-title">Title</label>
        <input type="text" id="new-title" name="new-title" required>
      </div>
      <div class="form-group">
        <label for="new-author">Author</label>
        <input type="text" id="new-author" name="new-author" required>
      </div>
      <div class="form-group">
        <label for="new-price">Price (VND)</label>
        <input type="number" id="new-price" name="new-price" required>
      </div>
      <div class="form-group">
        <label for="new-cover">Book Cover</label>
        <input type="file" id="new-cover" name="new-cover-file" accept="image/*">
        <input type="text" id="new-cover-url" name="new-cover-url" placeholder="Nh·∫≠p URL ·∫£nh">
        <div class="cover-preview">
          <img id="cover-preview-img" src="" alt="Preview" style="display:none;">
        </div>
      </div>
      <button type="submit" class="btn-submit">Save</button>
    </form>
  </div>
</div>

  <!-- Screen Crop Overlay -->
  <div id="screen-crop-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.25); z-index:9999; cursor:crosshair;"></div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="{{ url_for('static', filename='js/chat.js') }}"></script>

  <script>
  async function loadBooks() {
    try {
      const res = await fetch("/api/books");
      const data = await res.json();

      if (data.ok) {
        const container = document.getElementById("book-list");
        container.innerHTML = ""; // clear

        data.books.slice(0, 12).forEach(book => {
          const card = document.createElement("div");
          card.className = "book-card";

          card.innerHTML = `
            <img src="${book.cover}" alt="${book.title}">
            <h3>${book.title}</h3>
            <p>${book.author}</p>
            <span class="price">${book.price} VND</span>
            <button class="delete-btn" data-id="${book._id}">üóëÔ∏è Delete</button>
          `;

          container.appendChild(card);
        });

        // G·∫Øn event click cho n√∫t delete
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.getAttribute("data-id");
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s√°ch n√†y?")) return;

            const res = await fetch("/api/delete-book", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id })
            });

            const result = await res.json();
            alert(result.message);
            if (result.ok) loadBooks(); // refresh list
          });
        });
      }
    } catch (err) {
      console.error("‚ùå Error loading books:", err);
    }
  }
  window.onload = loadBooks;
  </script>
  <script>
    async function loadRecommended() {
      try {
        const res = await fetch("/api/recommended");
        const data = await res.json();

        if (!data.ok) return;
        const recList = document.getElementById("recommended-list");
        recList.innerHTML = "";

        data.books.forEach(book => {
          const div = document.createElement("div");
          div.className = "thumb-card";
          div.onclick = () => openBookModal(book.title, book.author, book.price, book.cover);

          div.innerHTML = `
            <img src="${book.cover}" alt="${book.title}">
          `;
          recList.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading recommended:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", loadRecommended);

  </script>
  <script>
      function openBookModal(title, author, price, cover) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-author").textContent = author;
        document.getElementById("modal-price").textContent = price + " VND";
        document.getElementById("modal-cover").src = cover;
        document.getElementById("book-modal").style.display = "flex";
      }
      function closeBookModal() {
        document.getElementById("book-modal").style.display = "none";
      }
  </script>
</body>
</html>
